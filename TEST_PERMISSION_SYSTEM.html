<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Permission System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        input,
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .quiz-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .permission-buttons {
            margin-top: 10px;
        }

        .permission-buttons button {
            font-size: 12px;
            padding: 5px 10px;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-delete {
            background: #dc3545;
        }

        .btn-view {
            background: #6c757d;
        }
    </style>
</head>

<body>
    <h1>üîê Test H·ªá Th·ªëng Quy·ªÅn Quiz</h1>

    <div class="test-section">
        <h2>1. Thi·∫øt L·∫≠p Ng∆∞·ªùi D√πng</h2>
        <label>T√™n ng∆∞·ªùi d√πng hi·ªán t·∫°i:</label>
        <input type="text" id="current-user" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" value="">
        <button onclick="setCurrentUser()">ƒê·∫∑t l√†m ng∆∞·ªùi d√πng hi·ªán t·∫°i</button>
        <button onclick="clearUser()">X√≥a ng∆∞·ªùi d√πng</button>

        <div id="user-status" class="test-result info">
            Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c ƒë·∫∑t
        </div>
    </div>

    <div class="test-section">
        <h2>2. T·∫°o Quiz Test</h2>
        <label>T√™n quiz:</label>
        <input type="text" id="quiz-title" placeholder="T√™n quiz" value="Quiz Test">

        <label>Ng∆∞·ªùi t·∫°o:</label>
        <input type="text" id="quiz-owner" placeholder="T√™n ng∆∞·ªùi t·∫°o" value="">

        <button onclick="addTestQuiz()">Th√™m Quiz Test</button>
        <button onclick="clearQuizzes()">X√≥a t·∫•t c·∫£ Quiz</button>
    </div>

    <div class="test-section">
        <h2>3. Danh S√°ch Quiz & Quy·ªÅn</h2>
        <div id="quiz-list">
            <div class="info test-result">Ch∆∞a c√≥ quiz n√†o</div>
        </div>
    </div>

    <div class="test-section">
        <h2>4. Test Admin Mode</h2>
        <button onclick="toggleAdminMode()">B·∫≠t/T·∫Øt Admin Mode</button>
        <div id="admin-status" class="test-result info">Admin Mode: T·∫Øt</div>
    </div>

    <div class="test-section">
        <h2>5. Test K·∫øt Qu·∫£</h2>
        <button onclick="runAllTests()">Ch·∫°y T·∫•t C·∫£ Test</button>
        <div id="test-results"></div>
    </div>

    <script>
        // Mock ExploreQuizManager
        class MockExploreQuizManager {
            constructor() {
                this.currentUserName = localStorage.getItem('userName') || '';
                this.isAdminMode = false;
                this.testQuizzes = [];
            }

            checkQuizPermission(quiz, action = 'view') {
                const currentUserName = this.currentUserName || localStorage.getItem('userName') || '';
                const isAdmin = this.isAdminMode;

                console.log('üîê Checking permission:', {
                    action,
                    currentUser: currentUserName,
                    quizOwner: quiz.user_name || quiz.userName,
                    isAdmin
                });

                if (isAdmin) {
                    return true;
                }

                switch (action) {
                    case 'view':
                    case 'practice':
                        return true;
                    case 'edit':
                    case 'delete':
                        const quizOwner = quiz.user_name || quiz.userName || '';
                        return currentUserName.trim().toLowerCase() === quizOwner.trim().toLowerCase();
                    default:
                        return false;
                }
            }

            generateQuizActionButtons(quiz) {
                const canEdit = this.checkQuizPermission(quiz, 'edit');
                const canDelete = this.checkQuizPermission(quiz, 'delete');

                let buttons = `<button class="btn-view">Xem</button>`;

                if (canEdit) {
                    buttons += `<button class="btn-edit">S·ª≠a</button>`;
                }

                if (canDelete) {
                    buttons += `<button class="btn-delete">X√≥a</button>`;
                }

                return buttons;
            }
        }

        // Kh·ªüi t·∫°o mock manager
        const mockManager = new MockExploreQuizManager();

        // Functions
        function setCurrentUser() {
            const userName = document.getElementById('current-user').value.trim();
            mockManager.currentUserName = userName;
            localStorage.setItem('userName', userName);

            document.getElementById('user-status').innerHTML =
                `<strong>Ng∆∞·ªùi d√πng hi·ªán t·∫°i:</strong> ${userName || 'Ch∆∞a ƒë·∫∑t'}`;
            document.getElementById('user-status').className =
                userName ? 'test-result success' : 'test-result error';

            renderQuizzes();
        }

        function clearUser() {
            mockManager.currentUserName = '';
            localStorage.removeItem('userName');
            document.getElementById('current-user').value = '';
            document.getElementById('user-status').innerHTML = 'Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o ƒë∆∞·ª£c ƒë·∫∑t';
            document.getElementById('user-status').className = 'test-result info';
            renderQuizzes();
        }

        function addTestQuiz() {
            const title = document.getElementById('quiz-title').value.trim();
            const owner = document.getElementById('quiz-owner').value.trim();

            if (!title || !owner) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n quiz v√† ng∆∞·ªùi t·∫°o');
                return;
            }

            const quiz = {
                id: Date.now().toString(),
                title: title,
                userName: owner,
                user_name: owner,
                totalQuestions: Math.floor(Math.random() * 20) + 5
            };

            mockManager.testQuizzes.push(quiz);
            renderQuizzes();

            // Clear inputs
            document.getElementById('quiz-title').value = 'Quiz Test ' + (mockManager.testQuizzes.length + 1);
            document.getElementById('quiz-owner').value = '';
        }

        function clearQuizzes() {
            mockManager.testQuizzes = [];
            renderQuizzes();
        }

        function toggleAdminMode() {
            mockManager.isAdminMode = !mockManager.isAdminMode;
            document.getElementById('admin-status').innerHTML =
                `Admin Mode: ${mockManager.isAdminMode ? 'B·∫≠t' : 'T·∫Øt'}`;
            document.getElementById('admin-status').className =
                mockManager.isAdminMode ? 'test-result success' : 'test-result info';
            renderQuizzes();
        }

        function renderQuizzes() {
            const container = document.getElementById('quiz-list');

            if (mockManager.testQuizzes.length === 0) {
                container.innerHTML = '<div class="info test-result">Ch∆∞a c√≥ quiz n√†o</div>';
                return;
            }

            const currentUser = mockManager.currentUserName || localStorage.getItem('userName') || 'Ch∆∞a ƒë·∫∑t';

            let html = `<div class="info test-result">
                <strong>Ng∆∞·ªùi d√πng hi·ªán t·∫°i:</strong> ${currentUser}<br>
                <strong>Admin Mode:</strong> ${mockManager.isAdminMode ? 'B·∫≠t' : 'T·∫Øt'}
            </div>`;

            mockManager.testQuizzes.forEach(quiz => {
                const canEdit = mockManager.checkQuizPermission(quiz, 'edit');
                const canDelete = mockManager.checkQuizPermission(quiz, 'delete');
                const isOwner = (quiz.userName || '').toLowerCase() === currentUser.toLowerCase();

                html += `
                    <div class="quiz-card">
                        <h4>${quiz.title}</h4>
                        <p><strong>Ng∆∞·ªùi t·∫°o:</strong> ${quiz.userName}</p>
                        <p><strong>S·ªë c√¢u:</strong> ${quiz.totalQuestions}</p>
                        <p><strong>B·∫°n l√† ch·ªß s·ªü h·ªØu:</strong> ${isOwner ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
                        <p><strong>Quy·ªÅn s·ª≠a:</strong> ${canEdit ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
                        <p><strong>Quy·ªÅn x√≥a:</strong> ${canDelete ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
                        <div class="permission-buttons">
                            ${mockManager.generateQuizActionButtons(quiz)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function runAllTests() {
            const results = document.getElementById('test-results');
            let html = '<h3>K·∫øt Qu·∫£ Test:</h3>';
            let passCount = 0;
            let totalTests = 0;

            // Test 1: User kh√¥ng c√≥ quy·ªÅn s·ª≠a quiz c·ªßa ng∆∞·ªùi kh√°c
            totalTests++;
            mockManager.currentUserName = 'User1';
            const quiz1 = { userName: 'User2', title: 'Quiz c·ªßa User2' };
            const canEdit1 = mockManager.checkQuizPermission(quiz1, 'edit');
            if (!canEdit1) {
                html += '<div class="success test-result">‚úÖ Test 1 PASS: User kh√¥ng th·ªÉ s·ª≠a quiz c·ªßa ng∆∞·ªùi kh√°c</div>';
                passCount++;
            } else {
                html += '<div class="error test-result">‚ùå Test 1 FAIL: User c√≥ th·ªÉ s·ª≠a quiz c·ªßa ng∆∞·ªùi kh√°c</div>';
            }

            // Test 2: User c√≥ quy·ªÅn s·ª≠a quiz c·ªßa ch√≠nh m√¨nh
            totalTests++;
            const quiz2 = { userName: 'User1', title: 'Quiz c·ªßa User1' };
            const canEdit2 = mockManager.checkQuizPermission(quiz2, 'edit');
            if (canEdit2) {
                html += '<div class="success test-result">‚úÖ Test 2 PASS: User c√≥ th·ªÉ s·ª≠a quiz c·ªßa ch√≠nh m√¨nh</div>';
                passCount++;
            } else {
                html += '<div class="error test-result">‚ùå Test 2 FAIL: User kh√¥ng th·ªÉ s·ª≠a quiz c·ªßa ch√≠nh m√¨nh</div>';
            }

            // Test 3: Admin c√≥ quy·ªÅn s·ª≠a m·ªçi quiz
            totalTests++;
            mockManager.isAdminMode = true;
            const canEditAdmin = mockManager.checkQuizPermission(quiz1, 'edit');
            if (canEditAdmin) {
                html += '<div class="success test-result">‚úÖ Test 3 PASS: Admin c√≥ th·ªÉ s·ª≠a m·ªçi quiz</div>';
                passCount++;
            } else {
                html += '<div class="error test-result">‚ùå Test 3 FAIL: Admin kh√¥ng th·ªÉ s·ª≠a quiz</div>';
            }

            // Test 4: Case-insensitive username
            totalTests++;
            mockManager.isAdminMode = false;
            mockManager.currentUserName = 'USER1';
            const quiz4 = { userName: 'user1', title: 'Quiz case test' };
            const canEdit4 = mockManager.checkQuizPermission(quiz4, 'edit');
            if (canEdit4) {
                html += '<div class="success test-result">‚úÖ Test 4 PASS: Username case-insensitive ho·∫°t ƒë·ªông</div>';
                passCount++;
            } else {
                html += '<div class="error test-result">‚ùå Test 4 FAIL: Username case-sensitive</div>';
            }

            // T·ªïng k·∫øt
            html += `<div class="${passCount === totalTests ? 'success' : 'error'} test-result">
                <strong>T·ªïng k·∫øt: ${passCount}/${totalTests} tests passed</strong>
            </div>`;

            results.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            const savedUser = localStorage.getItem('userName');
            if (savedUser) {
                document.getElementById('current-user').value = savedUser;
                mockManager.currentUserName = savedUser;
                setCurrentUser();
            }

            // Set default quiz owner to current user
            document.getElementById('quiz-owner').value = savedUser || '';
        });
    </script>
</body>

</html>