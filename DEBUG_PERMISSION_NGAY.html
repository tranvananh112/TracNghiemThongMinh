<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Permission Ngay</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }

        .debug-box {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üîç Debug Permission System - Ki·ªÉm Tra Ngay</h1>

    <div class="debug-box">
        <h2>1. Ki·ªÉm Tra LocalStorage</h2>
        <button class="btn-primary" onclick="checkLocalStorage()">Ki·ªÉm Tra LocalStorage</button>
        <button class="btn-warning" onclick="clearLocalStorage()">X√≥a LocalStorage</button>
        <div id="localStorage-result"></div>
    </div>

    <div class="debug-box">
        <h2>2. Thi·∫øt L·∫≠p T√™n Ng∆∞·ªùi D√πng</h2>
        <input type="text" id="test-username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" value="TestUser">
        <button class="btn-success" onclick="setTestUser()">ƒê·∫∑t T√™n Ng∆∞·ªùi D√πng</button>
        <div id="user-result"></div>
    </div>

    <div class="debug-box">
        <h2>3. Test Quiz Permission</h2>
        <div>
            <label>T√™n Quiz:</label>
            <input type="text" id="quiz-title" value="Quiz Test" style="width: 150px;">

            <label>Ng∆∞·ªùi T·∫°o:</label>
            <input type="text" id="quiz-owner" value="TestUser" style="width: 150px;">

            <button class="btn-primary" onclick="testPermission()">Test Permission</button>
        </div>
        <div id="permission-result"></div>
    </div>

    <div class="debug-box">
        <h2>4. Ki·ªÉm Tra ExploreQuizManager</h2>
        <button class="btn-primary" onclick="checkExploreManager()">Ki·ªÉm Tra Manager</button>
        <button class="btn-warning" onclick="testRealQuizzes()">Test Quiz Th·∫≠t</button>
        <div id="manager-result"></div>
    </div>

    <div class="debug-box">
        <h2>5. Console Log</h2>
        <button class="btn-info" onclick="showConsoleInstructions()">H∆∞·ªõng D·∫´n Console</button>
        <div id="console-instructions" style="display: none;">
            <div class="info debug-box">
                <h3>C√°ch Ki·ªÉm Tra Console:</h3>
                <ol>
                    <li>Nh·∫•n <strong>F12</strong> ƒë·ªÉ m·ªü Developer Tools</li>
                    <li>Ch·ªçn tab <strong>Console</strong></li>
                    <li>T√¨m c√°c d√≤ng log b·∫Øt ƒë·∫ßu b·∫±ng <strong>üîê</strong> ho·∫∑c <strong>üéØ</strong></li>
                    <li>Ki·ªÉm tra th√¥ng tin currentUser v√† quizOwner</li>
                    <li>Xem c√≥ l·ªói n√†o kh√¥ng</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Mock permission system ƒë·ªÉ test
        function checkQuizPermission(quiz, action = 'view') {
            const currentUserName = localStorage.getItem('userName') || localStorage.getItem('currentUserName') || '';
            const quizOwner = quiz.user_name || quiz.userName || quiz.owner || quiz.createdBy || '';

            console.log('üîê Debug Permission Check:', {
                action,
                currentUser: currentUserName,
                quizOwner: quizOwner,
                quiz: quiz
            });

            if (action === 'view' || action === 'practice') {
                return true;
            }

            if (action === 'edit' || action === 'delete') {
                if (!currentUserName) {
                    console.log('‚ùå No current user');
                    return false;
                }
                if (!quizOwner) {
                    console.log('‚ùå No quiz owner');
                    return false;
                }

                const hasPermission = currentUserName.trim().toLowerCase() === quizOwner.trim().toLowerCase();
                console.log(hasPermission ? '‚úÖ Permission granted' : '‚ùå Permission denied');
                return hasPermission;
            }

            return false;
        }

        function checkLocalStorage() {
            const result = document.getElementById('localStorage-result');
            const userName = localStorage.getItem('userName');
            const currentUserName = localStorage.getItem('currentUserName');

            let html = '<h3>LocalStorage Content:</h3>';
            html += `<p><strong>userName:</strong> ${userName || 'KH√îNG C√ì'}</p>`;
            html += `<p><strong>currentUserName:</strong> ${currentUserName || 'KH√îNG C√ì'}</p>`;

            // Hi·ªÉn th·ªã t·∫•t c·∫£ keys li√™n quan
            html += '<h4>T·∫•t c·∫£ keys trong localStorage:</h4><ul>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                if (key.toLowerCase().includes('user') || key.toLowerCase().includes('name')) {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                }
            }
            html += '</ul>';

            result.innerHTML = html;
            result.className = userName ? 'debug-box success' : 'debug-box warning';
        }

        function clearLocalStorage() {
            localStorage.removeItem('userName');
            localStorage.removeItem('currentUserName');
            document.getElementById('localStorage-result').innerHTML = '<p class="success">‚úÖ ƒê√£ x√≥a localStorage</p>';
            console.log('üóëÔ∏è Cleared localStorage');
        }

        function setTestUser() {
            const username = document.getElementById('test-username').value.trim();
            if (!username) {
                alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng');
                return;
            }

            localStorage.setItem('userName', username);
            localStorage.setItem('currentUserName', username);

            document.getElementById('user-result').innerHTML =
                `<p class="success">‚úÖ ƒê√£ ƒë·∫∑t t√™n ng∆∞·ªùi d√πng: <strong>${username}</strong></p>`;

            console.log('üë§ Set user:', username);
        }

        function testPermission() {
            const title = document.getElementById('quiz-title').value;
            const owner = document.getElementById('quiz-owner').value;
            const currentUser = localStorage.getItem('userName') || 'CH∆ØA ƒê·∫∂T';

            const testQuiz = {
                id: 'test-123',
                title: title,
                userName: owner,
                user_name: owner
            };

            const canView = checkQuizPermission(testQuiz, 'view');
            const canEdit = checkQuizPermission(testQuiz, 'edit');
            const canDelete = checkQuizPermission(testQuiz, 'delete');

            let html = `
                <h3>K·∫øt Qu·∫£ Test Permission:</h3>
                <p><strong>Ng∆∞·ªùi d√πng hi·ªán t·∫°i:</strong> ${currentUser}</p>
                <p><strong>Quiz:</strong> "${title}" (t·∫°o b·ªüi: ${owner})</p>
                <p><strong>Quy·ªÅn xem:</strong> ${canView ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
                <p><strong>Quy·ªÅn s·ª≠a:</strong> ${canEdit ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
                <p><strong>Quy·ªÅn x√≥a:</strong> ${canDelete ? '‚úÖ C√≥' : '‚ùå Kh√¥ng'}</p>
            `;

            if (canEdit && canDelete) {
                html += '<p class="success">‚úÖ B·∫°n c√≥ quy·ªÅn ch·ªânh s·ª≠a quiz n√†y!</p>';
            } else {
                html += '<p class="error">‚ùå B·∫°n kh√¥ng c√≥ quy·ªÅn ch·ªânh s·ª≠a quiz n√†y!</p>';
                if (currentUser === 'CH∆ØA ƒê·∫∂T') {
                    html += '<p class="warning">‚ö†Ô∏è B·∫°n ch∆∞a ƒë·∫∑t t√™n ng∆∞·ªùi d√πng!</p>';
                } else if (currentUser.toLowerCase() !== owner.toLowerCase()) {
                    html += '<p class="warning">‚ö†Ô∏è T√™n ng∆∞·ªùi d√πng kh√¥ng kh·ªõp v·ªõi ng∆∞·ªùi t·∫°o quiz!</p>';
                }
            }

            document.getElementById('permission-result').innerHTML = html;
        }

        function checkExploreManager() {
            let html = '<h3>Ki·ªÉm Tra ExploreQuizManager:</h3>';

            if (typeof window.exploreQuizManager !== 'undefined') {
                html += '<p class="success">‚úÖ exploreQuizManager t·ªìn t·∫°i</p>';

                const manager = window.exploreQuizManager;
                html += `<p><strong>currentUserName:</strong> ${manager.currentUserName || 'KH√îNG C√ì'}</p>`;
                html += `<p><strong>isAdminMode:</strong> ${manager.isAdminMode}</p>`;
                html += `<p><strong>sharedQuizzes count:</strong> ${manager.sharedQuizzes ? manager.sharedQuizzes.length : 'KH√îNG C√ì'}</p>`;

                if (manager.sharedQuizzes && manager.sharedQuizzes.length > 0) {
                    html += '<h4>Quiz ƒë·∫ßu ti√™n:</h4>';
                    const firstQuiz = manager.sharedQuizzes[0];
                    html += `<pre>${JSON.stringify(firstQuiz, null, 2)}</pre>`;
                }
            } else {
                html += '<p class="error">‚ùå exploreQuizManager kh√¥ng t·ªìn t·∫°i</p>';
                html += '<p class="warning">‚ö†Ô∏è C√≥ th·ªÉ b·∫°n ch∆∞a m·ªü trang ch√≠nh ho·∫∑c ch∆∞a load script</p>';
            }

            document.getElementById('manager-result').innerHTML = html;
        }

        function testRealQuizzes() {
            if (typeof window.exploreQuizManager === 'undefined') {
                document.getElementById('manager-result').innerHTML =
                    '<p class="error">‚ùå Vui l√≤ng m·ªü trang ch√≠nh tr∆∞·ªõc khi test</p>';
                return;
            }

            const manager = window.exploreQuizManager;
            const currentUser = localStorage.getItem('userName') || 'CH∆ØA ƒê·∫∂T';

            let html = `<h3>Test Quiz Th·∫≠t:</h3>`;
            html += `<p><strong>Ng∆∞·ªùi d√πng hi·ªán t·∫°i:</strong> ${currentUser}</p>`;
            html += `<p><strong>S·ªë quiz:</strong> ${manager.sharedQuizzes.length}</p>`;

            if (manager.sharedQuizzes.length > 0) {
                html += '<h4>Ki·ªÉm tra t·ª´ng quiz:</h4>';
                manager.sharedQuizzes.forEach((quiz, index) => {
                    const canEdit = manager.checkQuizPermission(quiz, 'edit');
                    const canDelete = manager.checkQuizPermission(quiz, 'delete');
                    const owner = quiz.user_name || quiz.userName || quiz.owner || 'KH√îNG R√ï';

                    html += `
                        <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
                            <strong>${index + 1}. ${quiz.title}</strong><br>
                            Ng∆∞·ªùi t·∫°o: ${owner}<br>
                            Quy·ªÅn s·ª≠a: ${canEdit ? '‚úÖ' : '‚ùå'} | 
                            Quy·ªÅn x√≥a: ${canDelete ? '‚úÖ' : '‚ùå'}
                        </div>
                    `;
                });
            } else {
                html += '<p class="warning">‚ö†Ô∏è Kh√¥ng c√≥ quiz n√†o ƒë·ªÉ test</p>';
            }

            document.getElementById('manager-result').innerHTML = html;
        }

        function showConsoleInstructions() {
            const instructions = document.getElementById('console-instructions');
            instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
        }

        // Auto-load khi trang ƒë∆∞·ª£c m·ªü
        document.addEventListener('DOMContentLoaded', function () {
            checkLocalStorage();

            // T·ª± ƒë·ªông ƒë·∫∑t t√™n n·∫øu c√≥ trong localStorage
            const savedUser = localStorage.getItem('userName');
            if (savedUser) {
                document.getElementById('test-username').value = savedUser;
                document.getElementById('quiz-owner').value = savedUser;
            }
        });

        // Log ƒë·ªÉ debug
        console.log('üîç Debug Permission System loaded');
        console.log('üìç Current localStorage userName:', localStorage.getItem('userName'));
        console.log('üìç Current localStorage currentUserName:', localStorage.getItem('currentUserName'));
    </script>
</body>

</html>